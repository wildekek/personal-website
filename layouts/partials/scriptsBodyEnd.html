{{ $main := slice (resources.Get "js/main.js") }}

{{ if .Site.Params.goToTop }}
    {{ $main = $main | append (resources.Get "js/goToTop.js") }}
{{ end }}

{{ $custom := slice }}
{{ range $script := .Site.Params.additionalScripts }}
    {{ $script_res := resources.Get $script }}
    {{ if not $script_res}}
        {{ erroridf "additional-script-loading-error" "Failed to load script \"%s\"" $script }}
    {{ else }}
        {{ $custom = $custom | append (resources.Get .) }}
    {{ end }}
{{ end }}

{{ if hugo.IsProduction }}
    {{ $main = $main | resources.Concat "js/main.js" | resources.Minify | resources.Fingerprint }}
    <script src="{{  $main.Permalink }}" integrity="{{ $main.Data.Integrity }}"></script>

    {{ if gt (len $custom) 0 }}
        {{ $custom = $custom | resources.Concat "js/custom.js" | resources.Minify | resources.Fingerprint }}
        <script src="{{  $custom.Permalink }}" integrity="{{ $custom.Data.Integrity }}"></script>
    {{ end }}
{{ else }}
    {{ $main = $main | resources.Concat "js/main.js" }}
    <script async src="{{  $main.Permalink }}" ></script>

    {{ if gt (len $custom) 0 }}
        {{ $custom = $custom | resources.Concat "js/custom.js" }}
        <script async src="{{  $custom.Permalink }}" ></script>
    {{ end }}
{{ end }}

{{ if .Params.mermaid }}
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        const mermaidTheme = () =>
            document.documentElement.classList.contains('dark') ? 'dark' : 'default';

        // Store original source before mermaid replaces elements with SVG
        document.querySelectorAll('.mermaid').forEach(el => {
            el.setAttribute('data-original', el.textContent.trim());
        });

        mermaid.initialize({ startOnLoad: true, theme: mermaidTheme() });

        new MutationObserver(() => {
            document.querySelectorAll('.mermaid').forEach(el => {
                el.removeAttribute('data-processed');
                el.textContent = el.getAttribute('data-original');
            });
            mermaid.initialize({ startOnLoad: false, theme: mermaidTheme() });
            mermaid.run();
        }).observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
    </script>
{{ end }}
